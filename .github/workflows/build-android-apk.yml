name: Build Android APK (Improved)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'
  ANDROID_COMPILE_SDK_VERSION: '34'

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest

    outputs:
      apk-name: ${{ steps.apk-info.outputs.apk-name }}
      version: ${{ steps.apk-info.outputs.version }}
      build-number: ${{ steps.apk-info.outputs.build-number }}
      environment: ${{ steps.apk-info.outputs.environment }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      # WICHTIG: SDK Build Tools explizit installieren
      - name: ðŸ“¦ Install Android Build Tools
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}"
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-${{ env.ANDROID_COMPILE_SDK_VERSION }}"

      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ” Create Environment File
        working-directory: ./frontend
        run: |
          # Environment Detection
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUILD_ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            BUILD_ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            BUILD_ENV="staging"
          else
            BUILD_ENV="development"
          fi
          
          echo "Building for environment: $BUILD_ENV"
          echo "BUILD_ENV=$BUILD_ENV" >> $GITHUB_ENV
          
          # Create .env.production
          cat > .env.production << EOF
          VITE_APP_NAME=NutriScan
          VITE_APP_VERSION=${{ github.ref_name }}
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          VITE_OPEN_FOOD_FACTS_URL=https://world.openfoodfacts.org
          VITE_ENABLE_AUTH=true
          VITE_ENABLE_SYNC=true
          VITE_ENABLE_PWA=true
          VITE_BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VITE_GIT_COMMIT_SHA=${{ github.sha }}
          VITE_GIT_BRANCH=${{ github.ref_name }}
          EOF
          
          echo "âœ… Environment file created for $BUILD_ENV"
          cat .env.production

      - name: ðŸ—ï¸ Build Vue.js App
        working-directory: ./frontend
        run: |
          echo "Building Vue.js application..."
          npm run build
          echo "Build completed!"
          ls -lah dist/

      - name: ðŸ“± Setup Capacitor
        working-directory: ./frontend
        run: |
          if [ ! -d "node_modules/@capacitor/cli" ]; then
            npm install @capacitor/core @capacitor/cli @capacitor/android
          fi
          
          echo "ðŸ”„ Syncing Capacitor..."
          npx cap sync android
          
          echo "ðŸ“‹ Capacitor Info:"
          npx cap doctor

      - name: ðŸ“ Update Android Version
        working-directory: ./frontend/android/app
        run: |
          VERSION_NAME=$(node -p "require('../../package.json').version")
          VERSION_CODE=${{ github.run_number }}
          
          echo "Version Name: $VERSION_NAME"
          echo "Version Code: $VERSION_CODE"
          
          # Backup original build.gradle
          cp build.gradle build.gradle.backup
          
          # Update versionCode and versionName
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" build.gradle
          sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" build.gradle
          
          echo "âœ… Updated build.gradle:"
          grep -E "versionCode|versionName" build.gradle

      - name: ðŸ”‘ Setup Keystore
        working-directory: ./frontend/android
        run: |
          # Decode und speichere Keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
          
          # Verify Keystore
          if [ ! -f "app/release.keystore" ]; then
            echo "âŒ Keystore wurde nicht erstellt!"
            exit 1
          fi
          
          echo "âœ… Keystore erstellt ($(stat -c%s app/release.keystore) bytes)"
          
          # Create key.properties
          cat > key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=release.keystore
          EOF
          
          echo "âœ… key.properties erstellt"
          
          # Verify Keystore kann gelesen werden (ohne Passwort anzuzeigen)
          keytool -list -v -keystore app/release.keystore -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" | head -20

      - name: ðŸ” Pre-Build Check
        working-directory: ./frontend/android
        run: |
          echo "=== Android Project Structure ==="
          ls -lah
          
          echo ""
          echo "=== App Directory ==="
          ls -lah app/
          
          echo ""
          echo "=== Gradle Version ==="
          ./gradlew --version
          
          echo ""
          echo "=== Check build.gradle ==="
          cat app/build.gradle | grep -A 20 "defaultConfig"

      - name: ðŸ—ï¸ Clean Build
        working-directory: ./frontend/android
        run: |
          echo "ðŸ§¹ Cleaning previous builds..."
          ./gradlew clean --stacktrace

      - name: ðŸ—ï¸ Build Release APK
        working-directory: ./frontend/android
        run: |
          echo "ðŸ”¨ Building Release APK..."
          ./gradlew assembleRelease --stacktrace --info --no-daemon
          
          echo ""
          echo "âœ… Build completed!"

      - name: ðŸ” Verify APK Output
        working-directory: ./frontend/android
        run: |
          echo "=== APK Build Outputs ==="
          find app/build/outputs/apk -type f -name "*.apk" -ls
          
          APK_PATH=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ Keine APK gefunden!"
            exit 1
          fi
          
          echo ""
          echo "âœ… APK gefunden: $APK_PATH"
          echo "ðŸ“¦ GrÃ¶ÃŸe: $(stat -c%s "$APK_PATH" | numfmt --to=iec-i --suffix=B)"

      - name: ðŸ” Verify APK Signature
        working-directory: ./frontend/android
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -1)
          
          echo "=== APK Signature Verification ==="
          $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/apksigner verify --verbose "$APK_PATH"
          
          if [ $? -eq 0 ]; then
            echo "âœ… APK ist korrekt signiert!"
          else
            echo "âŒ APK Signatur-Verifikation fehlgeschlagen!"
            exit 1
          fi

      - name: ðŸ” APK Detailed Info
        working-directory: ./frontend/android
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -1)
          
          echo "=== APK Package Information ==="
          $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/aapt dump badging "$APK_PATH" | grep -E "package:|sdkVersion:|targetSdkVersion:|launchable-activity:"
          
          echo ""
          echo "=== APK Permissions ==="
          $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/aapt dump permissions "$APK_PATH"
          
          echo ""
          echo "=== APK Certificate Info ==="
          keytool -printcert -jarfile "$APK_PATH" | head -30
          
          echo ""
          echo "=== ÃœberprÃ¼fe Package ID ==="
          PACKAGE_ID=$($ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*name='\([^']*\)'.*/\1/")
          echo "Package ID: $PACKAGE_ID"
          
          if [ "$PACKAGE_ID" != "com.jf.nutriscan" ]; then
            echo "âš ï¸ WARNUNG: Package ID stimmt nicht Ã¼berein!"
            echo "   Erwartet: com.jf.nutriscan"
            echo "   Gefunden: $PACKAGE_ID"
          else
            echo "âœ… Package ID korrekt!"
          fi

      - name: ðŸ“¦ Check APK Alignment
        working-directory: ./frontend/android
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -1)
          
          echo "=== Checking APK Alignment ==="
          if $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/zipalign -c -v 4 "$APK_PATH"; then
            echo "âœ… APK ist korrekt aligned!"
          else
            echo "âš ï¸ APK ist nicht aligned - wird korrigiert..."
            ALIGNED_APK="${APK_PATH%.apk}-aligned.apk"
            $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/zipalign -v 4 "$APK_PATH" "$ALIGNED_APK"
            mv "$ALIGNED_APK" "$APK_PATH"
            echo "âœ… APK wurde aligned!"
          fi

      - name: ðŸ“¦ Prepare APK
        id: apk-info
        run: |
          mkdir -p apk-output
          
          VERSION_NAME=$(node -p "require('./frontend/package.json').version")
          APK_PATH=$(find frontend/android/app/build/outputs/apk/release -type f -name "*.apk" | head -1)
          
          APK_NAME="NutriScan-${BUILD_ENV}-v${VERSION_NAME}-build${{ github.run_number }}.apk"
          
          cp "$APK_PATH" "apk-output/$APK_NAME"
          
          echo "apk-name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "build-number=${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "environment=${BUILD_ENV}" >> $GITHUB_OUTPUT
          
          echo "âœ… APK prepared: $APK_NAME"
          ls -lah apk-output/

      - name: ðŸ“Š Generate Build Info
        run: |
          cat > apk-output/build-info.txt << EOF
          NutriScan Build Information
          ===========================
          
          App Name: NutriScan
          Package: com.nutriscan.app
          Version: ${{ steps.apk-info.outputs.version }}
          Build Number: ${{ github.run_number }}
          Environment: ${{ steps.apk-info.outputs.environment }}
          
          Git Information
          ===============
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Author: ${{ github.actor }}
          
          Build Details
          =============
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Node Version: ${{ env.NODE_VERSION }}
          Java Version: ${{ env.JAVA_VERSION }}
          Android SDK: ${{ env.ANDROID_COMPILE_SDK_VERSION }}
          
          APK Information
          ===============
          File: ${{ steps.apk-info.outputs.apk-name }}
          Signed: Yes (Release Keystore)
          Min SDK: 22 (Android 5.1)
          Target SDK: 34 (Android 14)
          
          Installation
          ============
          1. Download the APK file
          2. Transfer to your Android device
          3. Enable "Install from Unknown Sources"
          4. Install the APK
          
          Troubleshooting
          ===============
          Falls Installation fehlschlÃ¤gt:
          - Stelle sicher, dass keine alte Version installiert ist
          - Aktiviere "Install from Unknown Sources" in den Einstellungen
          - PrÃ¼fe ob genug Speicherplatz verfÃ¼gbar ist
          - Versuche "adb install -r nutriscan.apk" wenn USB-Debugging aktiv ist
          
          Links
          =====
          Repository: ${{ github.server_url }}/${{ github.repository }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Built automatically by GitHub Actions
          EOF
          
          cat apk-output/build-info.txt

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutriscan-apk-${{ github.run_number }}
          path: |
            apk-output/*.apk
            apk-output/build-info.txt
          retention-days: 90

      - name: ðŸ§¹ Cleanup Secrets
        if: always()
        working-directory: ./frontend/android
        run: |
          rm -f app/release.keystore
          rm -f key.properties
          rm -f app/build.gradle.backup

  # AUTOMATISCHES RELEASE - BEI JEDEM PUSH AUF MAIN/DEVELOP
  create-release:
    name: Create GitHub Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download APK
        uses: actions/download-artifact@v4
        with:
          name: nutriscan-apk-${{ github.run_number }}
          path: ./release-files

      - name: ðŸ“ Generate Release Info
        id: release_info
        run: |
          VERSION="${{ needs.build-apk.outputs.version }}"
          BUILD="${{ needs.build-apk.outputs.build-number }}"
          ENV="${{ needs.build-apk.outputs.environment }}"
          
          # Release Tag: v1.0.0-build123 oder v1.0.0-staging-build123
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            RELEASE_TAG="v${VERSION}-build${BUILD}"
            RELEASE_NAME="NutriScan v${VERSION} (Build ${BUILD})"
            IS_PRERELEASE="false"
          else
            RELEASE_TAG="v${VERSION}-${ENV}-build${BUILD}"
            RELEASE_NAME="NutriScan v${VERSION} ${ENV^} (Build ${BUILD})"
            IS_PRERELEASE="true"
          fi
          
          echo "release-tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "release-name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "is-prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Release Tag: ${RELEASE_TAG}"
          echo "ðŸ“¦ Release Name: ${RELEASE_NAME}"
          echo "ðŸ“¦ Prerelease: ${IS_PRERELEASE}"

      - name: ðŸ“ Generate Release Notes
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸ“± NutriScan Android App
          
          ### ðŸ“¥ Download
          
          **APK Datei:** `${{ needs.build-apk.outputs.apk-name }}`
          
          Klicke unten bei **Assets** auf die APK-Datei zum Herunterladen.
          
          ---
          
          ### ðŸ“Š Build Information
          
          | Info | Wert |
          |------|------|
          | **Version** | ${{ needs.build-apk.outputs.version }} |
          | **Build Number** | ${{ needs.build-apk.outputs.build-number }} |
          | **Environment** | ${{ needs.build-apk.outputs.environment }} |
          | **Package** | `com.nutriscan.app` |
          | **Branch** | `${{ github.ref_name }}` |
          | **Commit** | `${{ github.sha }}` |
          | **Build Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |
          
          ---
          
          ### ðŸ“² Installation
          
          1. **Download** die APK-Datei unten bei "Assets"
          2. **Ãœbertrage** sie auf dein Android-GerÃ¤t
          3. **Aktiviere** "Installation aus unbekannten Quellen" in den Einstellungen
          4. **Tippe** auf die APK-Datei zur Installation
          5. **Fertig!** Starte NutriScan ðŸŽ‰
          
          ### âš ï¸ Troubleshooting
          
          Falls die Installation fehlschlÃ¤gt:
          - **Alte Version deinstallieren** falls vorhanden
          - **Speicherplatz prÃ¼fen** (mind. 100MB frei)
          - **"Aus unbekannten Quellen"** in Einstellungen aktivieren
          - Bei weiterem Problem: [Issue erstellen](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          ### âš™ï¸ Features
          
          - âœ… Barcode Scanner
          - âœ… Produktinformationen
          - âœ… NÃ¤hrwertanalyse
          - âœ… Offline-Modus
          - âœ… Synchronisation
          
          ---
          
          ### ðŸ”§ Technische Details
          
          - **Package ID:** `com.nutriscan.app`
          - **Min SDK:** 22 (Android 5.1+)
          - **Target SDK:** 34 (Android 14)
          - **Signiert:** Ja âœ…
          - **Aligned:** Ja âœ…
          
          ---
          
          ### ðŸ“ Changelog
          
          Siehe [Commit History](https://github.com/${{ github.repository }}/commits/${{ github.sha }}) fÃ¼r Details.
          
          ---
          
          ### ðŸ”— Links
          
          - **Repository:** [${{ github.repository }}](https://github.com/${{ github.repository }})
          - **Workflow:** [Build Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Issues:** [Report Bug](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          **Automatisch gebaut mit GitHub Actions** ðŸ¤–
          EOF
          
          cat release-notes.md

      - name: ðŸ·ï¸ Delete existing release if exists
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ steps.release_info.outputs.release-tag }}" --yes --cleanup-tag || true

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.release-tag }}
          name: ${{ steps.release_info.outputs.release-name }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ steps.release_info.outputs.is-prerelease }}
          make_latest: ${{ github.ref == 'refs/heads/main' }}
          files: |
            ./release-files/*.apk
            ./release-files/build-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release Created
        run: |
          echo "ðŸŽ‰ Release erfolgreich erstellt!"
          echo ""
          echo "ðŸ“¦ Tag: ${{ steps.release_info.outputs.release-tag }}"
          echo "ðŸ“± APK: ${{ needs.build-apk.outputs.apk-name }}"
          echo ""
          echo "ðŸ”— Download:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.release-tag }}"
          echo ""
          echo "ðŸ”— Direkter APK Download:"
          echo "   https://github.com/${{ github.repository }}/releases/download/${{ steps.release_info.outputs.release-tag }}/${{ needs.build-apk.outputs.apk-name }}"

  # PR COMMENT
  pr-comment:
    name: Comment on PR
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      pull-requests: write

    steps:
      - name: ðŸ’¬ Add PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ“± APK Build Erfolgreich!
            
            **Build Information:**
            - ðŸ“¦ Version: \`${{ needs.build-apk.outputs.version }}\`
            - ðŸ”¢ Build: \`${{ needs.build-apk.outputs.build-number }}\`
            - ðŸŒ Environment: \`${{ needs.build-apk.outputs.environment }}\`
            - ðŸ“± APK: \`${{ needs.build-apk.outputs.apk-name }}\`
            - ðŸ“ Commit: \`${{ github.sha }}\`
            
            **Download:**
            Das APK ist als Artifact verfÃ¼gbar.
            
            [ðŸ“¥ Download Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            **Installation:**
            1. Download Artifact (ZIP)
            2. Entpacken
            3. APK auf Android installieren
            
            ---
            ðŸ¤– Automatisch generiert von GitHub Actions
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # NOTIFICATION
  notify:
    name: Build Summary
    needs: [build-apk, create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“Š Build Summary
        run: |
          echo "======================================"
          echo "     NutriScan Build Summary"
          echo "======================================"
          echo ""
          
          if [[ "${{ needs.build-apk.result }}" == "success" ]]; then
            echo "âœ… APK Build: SUCCESS"
            echo "   ðŸ“¦ Version: ${{ needs.build-apk.outputs.version }}"
            echo "   ðŸ”¢ Build: ${{ needs.build-apk.outputs.build-number }}"
            echo "   ðŸŒ Environment: ${{ needs.build-apk.outputs.environment }}"
            echo "   ðŸ“± APK: ${{ needs.build-apk.outputs.apk-name }}"
          else
            echo "âŒ APK Build: FAILED"
          fi
          
          echo ""
          
          if [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "âœ… GitHub Release: CREATED"
            echo "   ðŸ”— https://github.com/${{ github.repository }}/releases"
          elif [[ "${{ needs.create-release.result }}" == "skipped" ]]; then
            echo "â­ï¸  GitHub Release: SKIPPED (not main/develop push)"
          else
            echo "âŒ GitHub Release: FAILED"
          fi
          
          echo ""
          echo "======================================"