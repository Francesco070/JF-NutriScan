name: Build Android APK

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'
  ANDROID_COMPILE_SDK_VERSION: '34'

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest

    outputs:
      apk-path: ${{ steps.apk-info.outputs.apk-path }}
      version: ${{ steps.apk-info.outputs.version }}
      build-number: ${{ steps.apk-info.outputs.build-number }}

    strategy:
      matrix:
        build_type: [release]

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ” Create Environment File
        working-directory: ./frontend
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUILD_ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            BUILD_ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            BUILD_ENV="staging"
          else
            BUILD_ENV="development"
          fi
          
          echo "Building for environment: $BUILD_ENV"
          echo "BUILD_ENV=$BUILD_ENV" >> $GITHUB_ENV
          
          cat > .env.production << EOF
          VITE_APP_NAME=NutriScan
          VITE_APP_VERSION=${{ github.ref_name }}
          VITE_API_BASE_URL=${{ secrets[format('API_BASE_URL_{0}', env.BUILD_ENV)] || secrets.API_BASE_URL_PRODUCTION }}
          VITE_OPEN_FOOD_FACTS_URL=https://world.openfoodfacts.org
          VITE_ENABLE_AUTH=true
          VITE_ENABLE_SYNC=true
          VITE_ENABLE_PWA=true
          VITE_BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VITE_GIT_COMMIT_SHA=${{ github.sha }}
          VITE_GIT_BRANCH=${{ github.ref_name }}
          EOF
          
          echo "âœ… Environment file created for $BUILD_ENV"

      - name: ðŸ—ï¸ Build Vue.js App
        working-directory: ./frontend
        run: npm run build

      - name: ðŸ“± Setup Capacitor
        working-directory: ./frontend
        run: |
          if [ ! -d "node_modules/@capacitor/cli" ]; then
            npm install @capacitor/core @capacitor/cli @capacitor/android
          fi
          npx cap sync android

      - name: ðŸ“ Update Android Version
        working-directory: ./frontend/android/app
        run: |
          VERSION_NAME=$(node -p "require('../../package.json').version")
          VERSION_CODE=${{ github.run_number }}
          
          echo "Version Name: $VERSION_NAME"
          echo "Version Code: $VERSION_CODE"
          
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" build.gradle
          sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" build.gradle

      - name: ðŸ”‘ Setup Keystore (Release only)
        if: matrix.build_type == 'release'
        working-directory: ./frontend/android
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
          
          cat > key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=release.keystore
          EOF

      - name: ðŸ—ï¸ Build APK
        working-directory: ./frontend/android
        run: |
          if [[ "${{ matrix.build_type }}" == "release" ]]; then
            ./gradlew assembleRelease --stacktrace
          else
            ./gradlew assembleDebug --stacktrace
          fi

      - name: ðŸ“¦ Prepare APK Artifacts
        id: apk-info
        run: |
          mkdir -p apk-output
          
          VERSION_NAME=$(node -p "require('./frontend/package.json').version")
          
          if [[ "${{ matrix.build_type }}" == "release" ]]; then
            cp frontend/android/app/build/outputs/apk/release/*.apk apk-output/
            cd apk-output
            for file in *.apk; do
              NEW_NAME="NutriScan-${BUILD_ENV}-v${VERSION_NAME}-build${{ github.run_number }}.apk"
              mv "$file" "$NEW_NAME"
              echo "apk-path=$NEW_NAME" >> $GITHUB_OUTPUT
            done
          else
            cp frontend/android/app/build/outputs/apk/debug/*.apk apk-output/
            cd apk-output
            for file in *.apk; do
              NEW_NAME="NutriScan-${BUILD_ENV}-v${VERSION_NAME}-build${{ github.run_number }}-debug.apk"
              mv "$file" "$NEW_NAME"
              echo "apk-path=$NEW_NAME" >> $GITHUB_OUTPUT
            done
          fi
          
          echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "build-number=${{ github.run_number }}" >> $GITHUB_OUTPUT
          
          cd ..
          ls -lah apk-output/

      - name: ðŸ“Š Generate APK Info
        run: |
          cat > apk-output/build-info.txt << EOF
          Build Information
          ==================
          App: NutriScan
          Version: ${{ steps.apk-info.outputs.version }}
          Build Number: ${{ github.run_number }}
          Environment: ${BUILD_ENV}
          Build Type: ${{ matrix.build_type }}
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref_name }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Workflow: ${{ github.workflow }}
          
          Installation
          ============
          1. Download the APK file
          2. Transfer to your Android device
          3. Enable "Install from Unknown Sources"
          4. Install the APK
          
          API Configuration
          ================
          Default API URL: ${{ secrets.API_BASE_URL_PRODUCTION || 'Not configured' }}
          
          ---
          Built with GitHub Actions
          Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutriscan-apk-${{ matrix.build_type }}-${{ github.run_number }}
          path: |
            apk-output/*.apk
            apk-output/build-info.txt
          retention-days: 90

      - name: ðŸ§¹ Cleanup Secrets
        if: always()
        working-directory: ./frontend/android
        run: |
          rm -f app/release.keystore
          rm -f key.properties

  # NEUER JOB: Automatisches Release erstellen
  create-release:
    name: Create GitHub Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') ||
      startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: nutriscan-apk-release-${{ github.run_number }}
          path: ./release-files

      - name: ðŸ“ Generate Release Tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            VERSION=$(node -p "require('./frontend/package.json').version")
            TAG_NAME="v${VERSION}-build${{ github.run_number }}"
          fi
          
          echo "tag-name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Release will be created with tag: ${TAG_NAME}"

      - name: ðŸ“ Create Release Notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸ“± NutriScan Android APK
          
          ### ðŸ“¦ Download
          
          **APK File:** `${{ needs.build-apk.outputs.apk-path }}`
          
          ### ðŸ“Š Build Information
          
          - **Version:** ${{ needs.build-apk.outputs.version }}
          - **Build Number:** ${{ needs.build-apk.outputs.build-number }}
          - **Environment:** Production
          - **Commit:** `${{ github.sha }}`
          - **Branch:** `${{ github.ref_name }}`
          - **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ðŸ“² Installation
          
          1. **Download** the APK file below
          2. **Transfer** to your Android device
          3. **Enable** "Install from Unknown Sources" in Settings
          4. **Tap** on the APK file to install
          5. **Launch** NutriScan!
          
          ### âš™ï¸ Configuration
          
          - Default API URL is pre-configured
          - No additional setup required
          - All features enabled
          
          ### ðŸ”’ Security
          
          - Signed with official release keystore
          - Built via GitHub Actions
          - Source code: ${{ github.server_url }}/${{ github.repository }}
          
          ### ðŸ“ Changelog
          
          See commit history for detailed changes.
          
          ---
          
          **Built automatically by GitHub Actions**  
          Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          
          cat release-notes.md

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag-name }}
          name: NutriScan ${{ steps.tag.outputs.tag-name }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag-name, 'beta') || contains(steps.tag.outputs.tag-name, 'alpha') || contains(steps.tag.outputs.tag-name, 'build') }}
          files: |
            ./release-files/*.apk
            ./release-files/build-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Œ Pin Latest Release (Optional)
        if: startsWith(github.ref, 'refs/tags/v') && !contains(steps.tag.outputs.tag-name, 'beta') && !contains(steps.tag.outputs.tag-name, 'alpha')
        run: |
          echo "âœ… This is a stable release: ${{ steps.tag.outputs.tag-name }}"
          echo "It will appear as the 'Latest' release on GitHub"

  notify:
    name: Send Notifications
    needs: [build-apk, create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“§ Notify Success
        if: needs.build-apk.result == 'success'
        run: |
          echo "âœ… APK Build successful!"
          echo "Version: ${{ needs.build-apk.outputs.version }}"
          echo "Build: ${{ needs.build-apk.outputs.build-number }}"
          
          if [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "âœ… GitHub Release created!"
            echo "Check: https://github.com/${{ github.repository }}/releases"
          fi

      - name: ðŸš¨ Notify Failure
        if: needs.build-apk.result == 'failure'
        run: |
          echo "âŒ APK Build failed!"
          echo "Check the logs for details"